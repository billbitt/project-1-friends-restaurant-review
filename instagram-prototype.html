<html>
<head>
    <title>#thatsmyjam instagram prototype</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script
  src="https://code.jquery.com/jquery-3.1.1.min.js"
  integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
  crossorigin="anonymous"></script>
    <meta charset="utf-8">
    <style>
        #title, #main{      
                margin: auto;
                margin-bottom: 10px;
            }

        .container .panel-heading, .jumbotron, .btn-primary{
            background-color: navy;
            color: white;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="jumbotron" id="title">
            <h1>#thatsmyjam</h1>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Instragram Prototype</h3>
            </div>
            
            <div class="panel-body">
                <div id="login">
                    <a href="https://api.instagram.com/oauth/authorize/?client_id=7c89da9d27cd49f9a18e2d6155032011&redirect_uri=https://jesseharold.github.io/project-1-friends-restaurant-review/instagram-prototype.html&response_type=token">Click here to log in with instagram</a>
                </div>
                <div id="response">
                </div>
            </div>
        </div>
        
<!--
/*
program flow:

user logs in w instagram
    look up their IG username in our DB of users, add if new
    retrieve their friends list from IG
        add / update in our DB on their user object
    get their friends' reviews and photos from the DB
        populate the map w friends reviews
    check IG to see if there are new photos from their friends
        update the DB with new reviews
        update the map
    check to see if they have new instagram photos with the hashtag
        add new photos to our DB as reviews
        prompt them to add text reviews to the photos
        if any tagged photos are missing location information, prompt them to add it, possibly from google places data


    all users
        have map ready to filter displayed reviews by author
        have map ready to add a new review from the map button
            when adding a new review, is it possible to use the instagram api to add a new photo???
        have app ready to change the location of the map
*/
-->


            <script src="https://www.gstatic.com/firebasejs/3.6.0/firebase.js"></script>
            <script lang="javascript">
            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyDiSNDLvK_AyIdGq7V-AvLjtdWTSNWvl98",
                authDomain: "thatsmyjam-harold.firebaseapp.com",
                databaseURL: "https://thatsmyjam-harold.firebaseio.com",
                storageBucket: "thatsmyjam-harold.appspot.com",
                messagingSenderId: "682404928881"
            };
            firebase.initializeApp(config);

            $("document").ready(function(){
                
                var database = firebase.database();
                var endpoint = "https://api.instagram.com/v1/";
                var token; //auth token required by instragram API
                var igQueryOwnPhotos = "users/self/media/recent?";
                var igQueryTag = "tags/thatsmyjam/media/recent?";
                var igQuerySearch = "media/search?";
                var geoLocation;

                //check for auth token and store
                if (location.href.indexOf("#") > 0){
                    var authTokenString = location.href.split("#").pop();
                    var authToken = authTokenString.split("=");
                    if (authToken[0] === "access_token"){
                        $("#login").hide();
                        token = authToken[1];
                        getOwnUserInfo();
                        getLocation();
                        getOwnImages();
                    } else {
                        $("#response").text("User did not give the app permission");
                    }
                }

            function getLocation(){
                $.get("https://ipinfo.io", function(response) {
                    var location = response.loc;
                    geoLocation = location.split(",");
                }, "jsonp");
            }
            
            function getOwnUserInfo(){
                $.ajax({
                    url: endpoint + "users/self/?" + "access_token=" + token,
                    method: 'GET',
                    dataType: "jsonp"
                })
                .done(function(response) {
                    checkForUser(response.data);
                });
            }
            function checkForUser(dataFromIg){
                //console.log(dataFromIg);
                var user = {
                    name: dataFromIg.full_name,
                    id: dataFromIg.id,
                    username: dataFromIg.username,
                    profilePicture: dataFromIg.profile_picture
                };
                // check to see if user exists with this id
                database.ref("users").once('value', function(snapshot) {
                    console.log(snapshot.val());
                    if (snapshot.hasChild(dataFromIg.id)){
                        console.log("updating existing");
                        database.ref("users").child(dataFromIg.id).update(user);
                    } else {
                        console.log("adding new");
                        database.ref("users").push(user);
                    }
                });
                // for all: update friends list
                getOwnFriends(dataFromIg.id);
            }
            function getOwnFriends(userID){
                 $.ajax({
                    url: endpoint + "/users/self/follows?" + "access_token=" + token,
                    method: 'GET',
                    dataType: "jsonp"
                })
                .done(function(response) {
                    console.log("got friends list: " + response);
                    updateFriendList(response.data, userID);
                });
            }
            function updateFriendList(dataFromIg, userID){
                //console.log(dataFromIg);
            }
            function getFriendsImages(latitude, longitude){
            }

            function getOwnImages(){
                //get images
                $.ajax({
                    url: endpoint + igQueryOwnPhotos + "access_token=" + token,
                    method: 'GET',
                    dataType: "jsonp"
                })
                .done(function(response) {
                    //console.log(response.data);
                    if(response.meta.code === 200){
                        for (var i = 0; i < response.data.length; i++) {  
                            if (response.data[i].type === "image"){
                                //look for the thatsmyjam hashtag
                                if (hasHashTag(response.data[i].tags)){
                                    // create current round of images
                                    createNewReview(response.data[i]);
                                }
                            }
                        }
                    } else {
                        console.error("meta error: "+response.meta.code);
                    }
                }).fail(function(err){
                    console.error("Failed: " + err);
                });
            }//function getOwnImages

            function hasHashTag(imageTags){
                var foundHashTag = false;
                //loop through all hashtags on this image
                for (var j = 0; j < imageTags.length; j++){
                    if(imageTags[j].toLowerCase() === "thatsmyjam"){
                        foundHashTag = true;
                    }
                }
                return foundHashTag;
            }//function hasHashTag

            function createNewReview(imageData){
                var thumbnail = $("<img>");
                thumbnail
                    .attr("src", imageData.images.thumbnail.url)
                    .addClass("thumbnail");
                $("#response").append(thumbnail);
                // get location information
                if(imageData.location){
                    if(imageData.location.name){
                        $("#response").append("<div class='restaurant-name'>" + "restaurant name: " + imageData.location.name);
                    }
                    if(imageData.location.latitude){
                        $("#response").append("<div class='restaurant-coords'>" + "latitude: " + imageData.location.latitude);
                    }
                    if(imageData.location.longitude){
                        $("#response").append("<div class='restaurant-coords'>" + "longitude: " + imageData.location.longitude);
                    }
                } else {
                    //promptForLocation(imageData);
                }

            }//function createNewReview

            function promptForLocation(imageData){
                // this is in the icebox, but it would be nice to add down the road.
                // probably should pass in a way to ref. this review in the database
                // once that exists
            }

            });//document ready
        </script>
</body>
</html>